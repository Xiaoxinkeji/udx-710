name: Build UDX710 Tools

on:
  push:
  workflow_dispatch:

jobs:
  build-arm:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
          sudo apt-get update
          sudo apt-get install -y nodejs

      - name: Cache cross compiler (aarch64)
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/tools/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu
          key: gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu

      - name: Configure cross compiler (aarch64)
        run: |
          mkdir -p $GITHUB_WORKSPACE/tools
          if [ ! -d "$GITHUB_WORKSPACE/tools/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu" ]; then
            wget https://releases.linaro.org/components/toolchain/binaries/7.5-2019.12/aarch64-linux-gnu/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu.tar.xz
            tar xf gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu.tar.xz -C $GITHUB_WORKSPACE/tools
          fi
          echo "PATH=$PATH:$GITHUB_WORKSPACE/tools/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu/bin" >> $GITHUB_ENV

      - name: build web
        run: |
          cd web
          npm install && npm run build

      - name: build server
        run: |
          cd src
          make

      - name: dopack
        run: |
          mkdir -p output/6677
          echo "#!/bin/sh" > start.sh
          echo "cd /home/root/6677" >> start.sh
          echo "chmod 755 *" >> start.sh
          echo "./server &" >> start.sh
          mv start.sh output/6677/
          cp -r web/dist output/6677/
          cp src/build/ofono-server output/6677/server
          # Create a compressed bundle
          cd output && zip -r ../udx710-uools-bundle.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: udx710-uools-bundle
          path: udx710-uools-bundle.zip

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: udx710-uools-bundle.zip
          body: |
            ## ğŸš€ UDX710-UOOLS: æå®¢è¿›åŒ–ç‰ˆ v2.1.0 (Audited)

            ### ğŸ›¡ï¸ å®‰å…¨åŠ å›º (Security Hardening)
            - **å¹½çµæŒ‡ä»¤ç™½åå•**: æ ¸å¿ƒç³»ç»Ÿå‘½ä»¤ï¼ˆé‡å¯/Shellï¼‰ç°å·²å¼ºåˆ¶æ ¡éªŒç®¡ç†å‘˜å·ç ç™½åå•ï¼Œæœç»è¶Šæƒé£é™©ã€‚
            - **SQL æ³¨å…¥ä¿®å¤**: å…¨é¢åŠ å›ºè‡ªåŠ¨åŒ–è§„åˆ™å­˜å‚¨é€»è¾‘ï¼Œé˜²æ­¢æ¶æ„è¯­æ³•æ³¨å…¥ã€‚

            ### ğŸ† æå®¢è¿›é˜¶ç‰¹æ€§ (Geek Evolution)
            - **å…¨æ ˆæˆå°±ç³»ç»Ÿ**: C åç«¯åŸç”Ÿé©±åŠ¨çš„è®¾å¤‡å®¡è®¡å¥–åŠ±ç³»ç»Ÿã€‚
            - **èœ‚çªæ‹“æ‰‘é›·è¾¾**: åŠ¨æ€ SVG å±•ç°åŸºç«™åšå¼ˆçŠ¶æ€ã€‚
            - **è‡ªåŠ¨åŒ–æµå¼•æ“**: è½»é‡çº§ IF-THEN è§„åˆ™ï¼Œæ”¯æŒæ¸©æ§è‡ªæ„ˆä¸å†…å­˜å›æ”¶ã€‚
            - **æå®¢æ—¥å¿—ç»ˆç«¯**: é€šè¿‡ WebSocket å®ç°å‡†ç§’çº§å®æ—¶å®¡è®¡æ—¥å¿—ã€‚

            ### âš¡ å†…å­˜å®ˆæŠ¤è€… (Memory Guardian)
            - **å†…æ ¸çº§ VM è°ƒä¼˜**: è‡ªåŠ¨è®¾ç½®ç³»ç»Ÿç¼“å­˜å›æ”¶ç­–ç•¥ï¼Œé˜²æ­¢ä½å†…å­˜å¥”æºƒã€‚
            - **OOM è¯„åˆ†é”å®š**: é”å®šæ ¸å¿ƒè¿›ç¨‹ä¼˜å…ˆçº§ï¼Œç¡®ä¿æç«¯æƒ…å†µä¸‹ç®¡ç†å…¥å£ä¸ä¸¢å¤±ã€‚

            ### ğŸ“– é¡¹ç›®é‡å¡‘ä¸æ–‡æ¡£
            - **UOOLS å“ç‰Œç¡®ç«‹**: æ­£å¼è„±ç¦» project-cpe è¿›å…¥ç‹¬ç«‹æ¼”è¿›è·¯çº¿ã€‚
            - **è¡¥å…¨ 2.1 è¡¥ä¸**: ä¿®å¤äº†å¤šä¸ªç¼–è¯‘å™¨éšå¼å£°æ˜åŠ Mongoose ç±»å‹ä¸åŒ¹é… Bugã€‚

            ---
            *æ³¨ï¼šé€‚ç”¨äº UDX710 å¹³å°æ‰€æœ‰é€šç”¨è®¾å¤‡ã€‚é»˜è®¤ç«¯å£ï¼š9898ã€‚*
          draft: false
          prerelease: false

