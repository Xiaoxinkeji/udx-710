name: Build UDX710 Tools

on:
  push:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-arm:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
          sudo apt-get update
          sudo apt-get install -y nodejs

      - name: Cache cross compiler (aarch64)
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/tools/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu
          key: gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu

      - name: Configure cross compiler (aarch64)
        run: |
          mkdir -p $GITHUB_WORKSPACE/tools
          if [ ! -d "$GITHUB_WORKSPACE/tools/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu" ]; then
            wget https://releases.linaro.org/components/toolchain/binaries/7.5-2019.12/aarch64-linux-gnu/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu.tar.xz
            tar xf gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu.tar.xz -C $GITHUB_WORKSPACE/tools
          fi
          echo "PATH=$PATH:$GITHUB_WORKSPACE/tools/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu/bin" >> $GITHUB_ENV

      - name: build web
        run: |
          cd web
          npm install && npm run build

      - name: build server
        run: |
          cd src
          make

      - name: dopack
        run: |
          mkdir -p output/9898
          echo "#!/bin/sh" > start.sh
          echo "cd /home/root/9898" >> start.sh
          echo "chmod 755 *" >> start.sh
          echo "./server &" >> start.sh
          mv start.sh output/9898/
          cp -r web/dist output/9898/
          cp src/build/ofono-server output/9898/server
          # Create a compressed bundle
          cd output && zip -r ../udx710-uools-bundle.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: udx710-uools-bundle
          path: udx710-uools-bundle.zip

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: udx710-uools-bundle.zip
          body: |
            ## ğŸš€ UDX710: å°å¿ƒç§‘æŠ€ v3.0.0 (Reborn)

            ### ğŸ†• æ–°å¢åŠŸèƒ½ (New Features)
            - **åœ¨çº¿æ’ä»¶å•†åŸ**: é›†æˆåœ¨çº¿æ’ä»¶æµè§ˆä¸å®‰è£…åŠŸèƒ½ï¼Œæ”¯æŒä¸€é”®æ‰©å±•ç³»ç»Ÿèƒ½åŠ›ã€‚
            - **ç½‘ç»œè¯¦æƒ…æ’ä»¶**: æ–°å¢ç½‘ç»œè¯¦æƒ…æ’ä»¶ï¼Œæä¾› RSRPã€SINR ç­‰ä¸“ä¸šä¿¡å·æŒ‡æ ‡ç›‘æ§ã€‚
            - **ç³»ç»Ÿå·¥å…·ç®±**: å†…ç½®ç³»ç»Ÿç»´æŠ¤å·¥å…·ï¼Œæ”¯æŒä¸€é”®æŒ‡ä»¤æ‰§è¡Œã€‚

            ### ğŸ› ï¸ ç³»ç»Ÿä¼˜åŒ– (Optimizations)
            - **å“ç‰Œé‡å¡‘**: é¡¹ç›®æ­£å¼æ›´åä¸ºâ€œå°å¿ƒç§‘æŠ€â€ï¼ŒUI å…¨é¢æ›´æ–°ã€‚
            - **è½»é‡åŒ–é‡æ„**: ç§»é™¤å†—ä½™çš„æˆå°±ç³»ç»Ÿã€æå®¢æ—¥å¿—å’Œæ‹“æ‰‘å›¾ï¼Œé™ä½ç³»ç»Ÿè´Ÿè½½ã€‚
            - **å®‰å…¨åŠ å›º**: ç§»é™¤æœªä½¿ç”¨çš„å¹¿æ’­æ¥å£ï¼Œä¿®å¤æ½œåœ¨çš„å®‰å…¨é£é™©ã€‚

            ### ğŸ› é—®é¢˜ä¿®å¤ (Fixes)
            - ä¿®å¤äº†è‹¥å¹²ç¼–è¯‘è­¦å‘Šå’Œéšå¼å£°æ˜é—®é¢˜ã€‚
            - ä¼˜åŒ–äº†å†…å­˜ç®¡ç†ç­–ç•¥ã€‚

            ---
            *æ³¨ï¼šé€‚ç”¨äº UDX710 å¹³å°æ‰€æœ‰é€šç”¨è®¾å¤‡ã€‚é»˜è®¤ç«¯å£ï¼š9898ã€‚*
          draft: false
          prerelease: false

