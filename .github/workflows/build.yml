name: Build UDX710 Tools

on:
  push:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-arm:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
          sudo apt-get update
          sudo apt-get install -y nodejs

      - name: Cache cross compiler (aarch64)
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/tools/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu
          key: gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu

      - name: Configure cross compiler (aarch64)
        run: |
          mkdir -p $GITHUB_WORKSPACE/tools
          if [ ! -d "$GITHUB_WORKSPACE/tools/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu" ]; then
            wget https://releases.linaro.org/components/toolchain/binaries/7.5-2019.12/aarch64-linux-gnu/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu.tar.xz
            tar xf gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu.tar.xz -C $GITHUB_WORKSPACE/tools
          fi
          echo "PATH=$PATH:$GITHUB_WORKSPACE/tools/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu/bin" >> $GITHUB_ENV

      - name: build web
        run: |
          cd web
          npm install && npm run build

      - name: build server
        run: |
          cd src
          make

      - name: dopack
        run: |
          mkdir -p output/9898
          echo "#!/bin/sh" > start.sh
          echo "cd /home/root/9898" >> start.sh
          echo "chmod 755 *" >> start.sh
          echo "./server &" >> start.sh
          mv start.sh output/9898/
          cp -r web/dist output/9898/
          cp src/build/ofono-server output/9898/server
          # Create a compressed bundle
          cd output && zip -r ../udx710-uools-bundle.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: udx710-uools-bundle
          path: udx710-uools-bundle.zip

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: udx710-uools-bundle.zip
          body: |
            ## ğŸš€ UDX710: å°æ–°ç§‘æŠ€ v3.1.1 (Security & Fixes)
            
            ### ğŸ“ æ›´æ–°æ—¥å¿— (Changelog)
            - **æ²™ç®±åŠ å›º**: é‡æ„æ’ä»¶æ‰§è¡Œæ²™ç®±ï¼Œä½¿ç”¨ Proxy æ‹¦æˆªå…¨å±€å¯¹è±¡è®¿é—®ï¼Œæå‡ç³»ç»Ÿå®‰å…¨æ€§
            - **å“ç‰Œæ¸…ç†**: å½»åº•ç§»é™¤æ‰€æœ‰æ®‹ç•™çš„ QQ ç¾¤ä¿¡æ¯ï¼Œå‡€åŒ–ç•Œé¢
            - **UI ä¼˜åŒ–**:
              - ä¿®å¤ç³»ç»Ÿç›‘æ§é¡µé¢çš„â€œä»£ç åâ€æ˜¾ç¤ºï¼Œè¿è¥å•†åŠçŠ¶æ€é¡¹å·²ç²¾å‡†ç¿»è¯‘ä¸ºä¸­æ–‡
              - è¡¥å……äº†ç”µæºå’Œç”µæ± çŠ¶æ€çš„ä¸­æ–‡æ˜ å°„
            - **å…¶å®ƒä¿®å¤**: ç§»é™¤ `fontawesome.js` ä¸­æœªä½¿ç”¨çš„ `faQq` å›¾æ ‡ï¼Œä¼˜åŒ–æ„å»ºä½“ç§¯

            ---
            *æ³¨ï¼šé€‚ç”¨äº UDX710 å¹³å°æ‰€æœ‰é€šç”¨è®¾å¤‡ã€‚é»˜è®¤ç«¯å£ï¼š9898ã€‚*
          draft: false
          prerelease: false

